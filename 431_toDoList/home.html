<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
      <title>Document</title>
</head>

<style>
#appname{
padding-left: 20px;
color: white;
font-size: 35px;
}

#logout{
    padding-right: 15px;
    font-size: 20px;
    text-decoration:none;
    color: white;


}
#userWelcome{
padding: 5px;
font-size: 32px;
font-weight: bold;
}

button{
    cursor: pointer;
}
#taskContainer{
    display: flex;
    flex-direction: column;
    padding: 15px;

}
form {
    max-width: 400px;
    margin: 0 auto;
}
input[type="text"] {
    width: 100%;
    margin-bottom: 10px;
    padding: 8px;
    box-sizing: content-box;
    border-radius: 10px;
}
.add-item-btn{
    color:rgb(0, 0, 0);
    padding: 5px;
    background-color: Transparent;
    border: none;
}
.add-item{
    display: flex;
    flex-direction: row;
    padding: 5px;
    margin-left: 80px;
}

#add-btn-font{
font-size: 15px;
}



.taskRow {
    padding: 10px;
    margin-bottom: 5px;
    border: 1px solid #ccc;
    background-color: #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    font-size: 32px;

}

.tdlTitle{
    list-style-type: square;
}

.tdlItems{
    padding: 7px;
    font-size: 20px;
    border-bottom: 2px solid black;
}


.btnDiv{
    padding:5px;
}
</style>
<body>
    
    <nav class="navbar navbar-dark bg-primary">
        <span id="appname" class="navbar-brand mb-0 h1">TaskHub</span>
        <a id="logout" class="navbar-brand mb-0" href="php/handle_logout.php">Logout</a>
    </nav>
    <div id="userWelcome">
    </div>
    <div id ="taskContainer">
        
    </div>
   
      <!-- Trigger the modal with a button -->
  <button type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#myModal">+ Add Task</button>

  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Create New To Do List</h4>
        </div>
        <div class="modal-body">
                <form id="addItemForm" action="php/post_new_TDL.php" method="post">
                <label for="title">To Do List Title:</label>
                <input type="text" id="title" name="title" placeholder="ex: Mondays goals" required> 
                <label>To Do List Items:</label>
                <div class ="userItems">
                    <input type="text" name="items[]" placeholder="Add an item to this list">
                </div> 
            </form>
            <div class = "add-item">
            <button class="add-item-btn"><p id ="add-btn-font"> Add Item &plus;</p></button>
             </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <!----The button below is what i want to use to submit form -->
            <button type="button" class="btn btn-primary modal-submit" data-dismiss="modal" >Submit</button>

        </div>
      </div>
      
    </div>
  </div>


</body>

<script>
"use strict";


//fetch user info 
async function getUserInfo() {
    try{
        let response = await fetch('php/get_TDL.php');
        let data = await response.json(); 
        console.log(data)
        return data;
    }
    catch (error) {
     console.error('Error fetching data:', error);
            }
}

//maps list title name to their corresponding tasks
// also preserves  the order of lists in TDL when button is clicked 
function showTDLTasks(targetTitle,namesArray, valuesArray) {
    // Check if a list is already displayed
    const existingList = this.nextSibling;
    if (existingList && existingList.tagName === "UL") {
        // If a list is already displayed, remove it
        existingList.parentNode.removeChild(existingList);
    } else {
        // Create a list of numbers
        const tasksList = document.createElement("ul");
        tasksList.className = "tdlTitle";
        for (let i = 0; i < namesArray.length; i++) {
            // if values == "" that indicates its a list without anything pending 
            // do not display a list with blank values
            if (namesArray[i] === targetTitle && valuesArray[i] !== "") {
                const listItem = document.createElement("li");
                listItem.className = "tdlItems"
                // Add the task text
                const taskText = document.createTextNode(valuesArray[i]);
                listItem.appendChild(taskText);
                // Append the list item to the tasks list
                tasksList.appendChild(listItem);
            }
        

        }
        //create a div so we can give some space between the button and the list
        const tasksUpdateDiv = document.createElement("div");
        tasksUpdateDiv.className = "btnDiv";
        tasksList.appendChild(tasksUpdateDiv);

        // create a button to modify list
        const tasksUpdate = document.createElement("button");
        tasksUpdate.innerHTML="Update Tasks";
        tasksUpdate.className ="btn btn-primary";
        
        tasksList.appendChild(tasksUpdate);
        // Insert the list of numbers after the clicked button
        this.parentNode.insertBefore(tasksList, this.nextSibling);
    }
}

// pass in user_info object to grab to do list name and text
//make the list name array into a set 
//send names and text arrays to another function to map TDL names to their corresponding tasks
 function showTDL(user_info){
    const container = document.getElementById("taskContainer");
        let list_names = user_info.list_name;
        let list_text = user_info.list_text;
        let list_names_set = new Set(user_info.list_name);

        list_names_set.forEach(function(listTitle) {
           let row = document.createElement("button");
           row.className ="taskRow";
           row.innerHTML = listTitle;
            
           row.addEventListener("click", function() {
     showTDLTasks.call(this,listTitle, list_names, list_text);
        });
           container.appendChild(row);

        });
 }


//Checks if user has been authenticated , if not redirects them to login page
// if authenticated grab users information
// display name
// calls showTDL to seperate unique task names into buttons
let user_info;
(async () => {
     user_info = await getUserInfo();
    if (user_info) {
        if(user_info.badLogin === false){
            window.location.href = 'http://localhost/431_toDoList/login.html';
        }
        document.getElementById("userWelcome").innerHTML = "Welcome back, " + user_info.name+"!";
        showTDL(user_info);

} else {
        console.error('User info not available');
      }
})();

//Dynamically adds input fields to modal  when add task button is clicked
document.querySelector('.add-item-btn').addEventListener('click', function() {

        let container = document.querySelector('.userItems');
        let input = document.createElement('input');
        input.type = 'text';
        input.name = 'items[]';
        input.placeholder = 'Add an item to this list';
        input.required = true;
        container.appendChild(input);
    });

    // grab form
    function submitForm() {
        document.getElementById('addItemForm').submit(); 
    }

    //Post request to server with new task added
    document.querySelector('.modal-submit').addEventListener('click', function() {
        submitForm(); 
    });

    async function getUserTDL() {
    try{
        let response = await fetch('php/get_TDL.php');
        let data = await response.json(); 
        console.log(data)
        return data;
    }
    catch (error) {
     console.error('Error fetching data:', error);
            }
}


</script>
</html>